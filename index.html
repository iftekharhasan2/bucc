<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ SERPENTINE</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0f;
      --panel: #0f0f1a;
      --grid: #12122a;
      --neon-green: #00ff88;
      --neon-cyan: #00e5ff;
      --neon-red: #ff2266;
      --neon-yellow: #ffe600;
      --neon-purple: #bf00ff;
      --text: #e0ffe0;
      --glow: 0 0 8px #00ff88, 0 0 20px #00ff8866;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Press Start 2P', monospace;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: repeating-linear-gradient(
        0deg, transparent, transparent 2px,
        rgba(0,255,136,0.02) 2px, rgba(0,255,136,0.02) 4px
      );
      pointer-events: none;
      z-index: 100;
    }

    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(0,255,136,0.04) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,255,136,0.04) 1px, transparent 1px);
      background-size: 40px 40px;
      animation: gridMove 20s linear infinite;
      pointer-events: none;
      z-index: 0;
    }

    @keyframes gridMove {
      0%   { transform: translate(0,0); }
      100% { transform: translate(40px,40px); }
    }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .page {
      position: relative;
      z-index: 10;
      display: flex;
      gap: 28px;
      align-items: flex-start;
      justify-content: center;
      flex-wrap: wrap;
      padding: 20px;
    }

    .left-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    h1 {
      font-family: 'Orbitron', sans-serif;
      font-weight: 900;
      font-size: clamp(1.3rem, 4vw, 2.8rem);
      color: var(--neon-green);
      text-shadow: var(--glow);
      letter-spacing: 8px;
      animation: flicker 4s infinite;
    }

    @keyframes flicker {
      0%,95%,100%{opacity:1} 96%{opacity:.7} 97%{opacity:1} 98%{opacity:.5} 99%{opacity:1}
    }

    /* â”€â”€ HUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .hud { display:flex; gap:32px; align-items:center; }
    .hud-box { text-align:center; }
    .hud-label { font-size:.42rem; color:var(--neon-cyan); letter-spacing:3px; margin-bottom:5px; opacity:.7; }
    .hud-value { font-size:1rem; color:var(--neon-green); text-shadow:var(--glow); }
    .speed-indicator { display:flex; gap:6px; align-items:center; }
    .speed-dot { width:7px;height:7px;border-radius:50%;background:var(--grid);border:1px solid var(--neon-green);transition:background .2s; }
    .speed-dot.active { background:var(--neon-green);box-shadow:0 0 6px var(--neon-green); }

    /* â”€â”€ Game canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .game-wrapper {
      position:relative;
      border:2px solid var(--neon-green);
      box-shadow:0 0 20px #00ff8844,inset 0 0 30px #00000066,0 0 60px #00ff8822;
      border-radius:4px;
    }
    canvas { display:block; background:var(--panel); outline:none; }

    .corner { position:absolute;width:12px;height:12px;border-color:var(--neon-cyan);border-style:solid; }
    .corner.tl{top:-2px;left:-2px;border-width:2px 0 0 2px}
    .corner.tr{top:-2px;right:-2px;border-width:2px 2px 0 0}
    .corner.bl{bottom:-2px;left:-2px;border-width:0 0 2px 2px}
    .corner.br{bottom:-2px;right:-2px;border-width:0 2px 2px 0}

    /* â”€â”€ In-canvas overlays â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .overlay {
      position:absolute;inset:0;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      background:rgba(10,10,15,.90);gap:16px;transition:opacity .3s;
    }
    .overlay.hidden { opacity:0; pointer-events:none; }

    .overlay-title {
      font-family:'Orbitron',sans-serif;
      font-size:clamp(.85rem,2.4vw,1.7rem);
      color:var(--neon-green);text-shadow:var(--glow);
      animation:pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}

    .overlay-sub { font-size:.42rem;color:var(--neon-cyan);letter-spacing:2px;opacity:.8;text-align:center;line-height:2; }

    .btn {
      padding:10px 24px;background:transparent;
      border:2px solid var(--neon-green);color:var(--neon-green);
      font-family:'Press Start 2P',monospace;font-size:.5rem;letter-spacing:2px;
      cursor:pointer;text-shadow:var(--glow);box-shadow:0 0 10px #00ff8844;
      transition:all .2s; tabindex:"-1";
    }
    .btn:hover { background:var(--neon-green);color:var(--bg);box-shadow:0 0 25px #00ff88;text-shadow:none; }
    .btn.red   { border-color:var(--neon-red);color:var(--neon-red);text-shadow:0 0 8px var(--neon-red); }
    .btn.red:hover { background:var(--neon-red);color:var(--bg); }
    .btn.cyan  { border-color:var(--neon-cyan);color:var(--neon-cyan);text-shadow:0 0 8px var(--neon-cyan); }
    .btn.cyan:hover { background:var(--neon-cyan);color:var(--bg); }

    .game-over-title { color:var(--neon-red);text-shadow:0 0 8px var(--neon-red),0 0 20px #ff226666;animation:none; }
    .final-score { font-size:.95rem;color:var(--neon-yellow);text-shadow:0 0 8px var(--neon-yellow); }
    .go-rank { font-size:.45rem;color:var(--neon-cyan);letter-spacing:2px; }

    .btn-row { display:flex;gap:12px;flex-wrap:wrap;justify-content:center; }

    /* â”€â”€ Submit score form (inside game-over overlay) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .submit-form {
      display:flex;flex-direction:column;gap:10px;align-items:center;width:300px;
    }
    .submit-form input {
      width:100%;padding:8px 12px;
      background:rgba(0,255,136,0.06);
      border:1px solid rgba(0,255,136,0.35);
      color:var(--neon-green);
      font-family:'Press Start 2P',monospace;font-size:.38rem;
      letter-spacing:1px;outline:none;border-radius:3px;
      transition:border-color .2s;
    }
    .submit-form input::placeholder { color:rgba(0,255,136,0.3); }
    .submit-form input:focus { border-color:var(--neon-green);box-shadow:0 0 8px #00ff8844; }
    .submit-msg { font-size:.38rem;letter-spacing:1px;text-align:center; }
    .submit-msg.ok  { color:var(--neon-green); }
    .submit-msg.err { color:var(--neon-red); }

    /* â”€â”€ Leaderboard panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .lb-panel {
      width:280px;
      border:2px solid rgba(0,255,136,0.3);
      border-radius:4px;
      background:rgba(15,15,26,.85);
      box-shadow:0 0 20px #00ff8811;
      overflow:hidden;
      backdrop-filter:blur(4px);
    }

    .lb-header {
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 16px;
      border-bottom:1px solid rgba(0,255,136,0.15);
      background:rgba(0,255,136,0.05);
    }
    .lb-title {
      font-family:'Orbitron',sans-serif;font-size:.6rem;
      color:var(--neon-green);letter-spacing:4px;text-shadow:var(--glow);
    }
    .lb-refresh {
      background:none;border:none;cursor:pointer;color:var(--neon-cyan);
      font-size:.9rem;opacity:.6;transition:opacity .2s, transform .4s;
      tabindex:"-1";
    }
    .lb-refresh:hover { opacity:1; }
    .lb-refresh.spinning { animation:spin .6s linear; }
    @keyframes spin { to { transform:rotate(360deg); } }

    .lb-body { padding:8px 0; min-height:320px; }

    .lb-row {
      display:grid;
      grid-template-columns:28px 1fr 60px;
      align-items:center;
      gap:6px;
      padding:8px 14px;
      border-bottom:1px solid rgba(0,255,136,0.06);
      transition:background .15s;
    }
    .lb-row:hover { background:rgba(0,255,136,0.05); }
    .lb-row.me { background:rgba(0,255,136,0.10); }

    .lb-rank { font-size:.45rem;color:var(--neon-cyan);text-align:center; }
    .lb-rank.gold   { color:#ffd700;text-shadow:0 0 6px #ffd700; }
    .lb-rank.silver { color:#c0c0c0;text-shadow:0 0 6px #c0c0c0; }
    .lb-rank.bronze { color:#cd7f32;text-shadow:0 0 6px #cd7f32; }

    .lb-info { overflow:hidden; }
    .lb-name  { font-size:.38rem;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
    .lb-email { font-size:.28rem;color:rgba(0,255,136,0.4);margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }

    .lb-score { font-size:.45rem;color:var(--neon-yellow);text-align:right;text-shadow:0 0 6px var(--neon-yellow); }

    .lb-empty { text-align:center;padding:40px 16px;font-size:.38rem;color:rgba(0,255,136,0.3);line-height:2; }
    .lb-loading { text-align:center;padding:30px;font-size:.38rem;color:rgba(0,255,136,0.4);animation:blink 1s infinite; }
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

    /* â”€â”€ Mobile D-Pad â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dpad { display:none;grid-template-columns:repeat(3,48px);grid-template-rows:repeat(3,48px);gap:5px; }
    @media (pointer:coarse),(max-width:520px) { .dpad{display:grid} }
    .dpad-btn {
      background:rgba(0,255,136,0.07);border:1px solid rgba(0,255,136,0.25);
      color:var(--neon-green);font-size:1.1rem;cursor:pointer;border-radius:6px;
      display:flex;align-items:center;justify-content:center;
      user-select:none;-webkit-tap-highlight-color:transparent;transition:background .1s;
    }
    .dpad-btn:active { background:rgba(0,255,136,0.28); }
    .dpad-empty { background:transparent;border:none; }

    .controls-hint { font-size:.35rem;color:rgba(255,255,255,0.2);letter-spacing:1px; }
  </style>
</head>
<body>
<div class="page">

  <!-- â”€â”€ Left col: game â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="left-col">
    <h1>SERPENTINE</h1>

    <div class="hud">
      <div class="hud-box">
        <div class="hud-label">SCORE</div>
        <div class="hud-value" id="score">0</div>
      </div>
      <div class="hud-box">
        <div class="hud-label">LEVEL</div>
        <div class="speed-indicator" id="speed-dots">
          <div class="speed-dot active"></div>
          <div class="speed-dot"></div>
          <div class="speed-dot"></div>
          <div class="speed-dot"></div>
          <div class="speed-dot"></div>
        </div>
      </div>
      <div class="hud-box">
        <div class="hud-label">BEST</div>
        <div class="hud-value" id="best">0</div>
      </div>
    </div>

    <div class="game-wrapper">
      <div class="corner tl"></div><div class="corner tr"></div>
      <div class="corner bl"></div><div class="corner br"></div>

      <canvas id="gameCanvas" width="400" height="400" tabindex="0"></canvas>

      <!-- Start overlay -->
      <div class="overlay" id="startOverlay">
        <div class="overlay-title">READY?</div>
        <div class="overlay-sub">ARROW KEYS or WASD to move<br>Eat the red dots. Don't crash.<br>P = pause</div>
        <button class="btn" id="startBtn" tabindex="-1">â–¶ START GAME</button>
      </div>

      <!-- Game over overlay -->
      <div class="overlay hidden" id="gameOverOverlay">
        <div class="overlay-title game-over-title">GAME OVER</div>
        <div class="overlay-sub" id="gameOverMsg">YOUR SCORE</div>
        <div class="final-score" id="finalScore">0</div>
        <div class="go-rank" id="goRank"></div>

        <!-- Submit score form -->
        <div class="submit-form" id="submitForm">
          <input type="text"  id="inputName"  placeholder="YOUR NAME"  maxlength="30" autocomplete="off" spellcheck="false" />
          <input type="email" id="inputEmail" placeholder="YOUR EMAIL" maxlength="100" autocomplete="off" spellcheck="false" />
          <button class="btn cyan" id="submitBtn" tabindex="-1">ğŸ“¤ SUBMIT SCORE</button>
          <div class="submit-msg" id="submitMsg"></div>
        </div>

        <div class="btn-row">
          <button class="btn red"  id="restartBtn"  tabindex="-1">â†º PLAY AGAIN</button>
          <button class="btn cyan" id="showLbBtn"   tabindex="-1">ğŸ† LEADERBOARD</button>
        </div>
      </div>
    </div>

    <!-- Mobile D-Pad -->
    <div class="dpad">
      <div class="dpad-empty"></div>
      <button class="dpad-btn" id="btn-up"    tabindex="-1">â–²</button>
      <div class="dpad-empty"></div>
      <button class="dpad-btn" id="btn-left"  tabindex="-1">â—€</button>
      <div class="dpad-empty"></div>
      <button class="dpad-btn" id="btn-right" tabindex="-1">â–¶</button>
      <div class="dpad-empty"></div>
      <button class="dpad-btn" id="btn-down"  tabindex="-1">â–¼</button>
      <div class="dpad-empty"></div>
    </div>

    <div class="controls-hint">ARROW KEYS / WASD Â· P = PAUSE</div>
  </div>

  <!-- â”€â”€ Right col: leaderboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="lb-panel">
    <div class="lb-header">
      <span class="lb-title">LEADERBOARD</span>
      <button class="lb-refresh" id="lbRefresh" tabindex="-1" title="Refresh">â†»</button>
    </div>
    <div class="lb-body" id="lbBody">
      <div class="lb-loading">LOADING...</div>
    </div>
  </div>

</div>

<script>
// â”€â”€ Canvas setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvas = document.getElementById('gameCanvas');
const ctx    = canvas.getContext('2d');
const CELL   = 20;
const COLS   = canvas.width  / CELL;
const ROWS   = canvas.height / CELL;
const SPEEDS = [150, 120, 90, 65, 45];

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let snake, dir, nextDir, food;
let score, level, paused, gameRunning, gameLoop;
let best = 0;
let currentPlayerEmail = '';   // track who just played

try { best = parseInt(localStorage.getItem('serpentine_best') || '0') || 0; } catch(_) {}
document.getElementById('best').textContent = best;

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const getSpeed = () => SPEEDS[Math.min(level, SPEEDS.length - 1)];

function updateSpeedDots() {
  document.querySelectorAll('.speed-dot').forEach((d,i) =>
    d.classList.toggle('active', i <= level)
  );
}

function placeFood() {
  let pos;
  do {
    pos = { x: Math.floor(Math.random()*COLS), y: Math.floor(Math.random()*ROWS) };
  } while (snake.some(s => s.x===pos.x && s.y===pos.y));
  food = pos;
}

function roundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);     ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
}

function blurActive() {
  if (document.activeElement && document.activeElement !== document.body)
    document.activeElement.blur();
}

// â”€â”€ Game lifecycle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startGame() {
  document.getElementById('startOverlay').classList.add('hidden');
  document.getElementById('gameOverOverlay').classList.add('hidden');
  document.getElementById('submitMsg').textContent = '';
  document.getElementById('submitForm').style.display = 'flex';
  document.getElementById('goRank').textContent = '';

  snake       = [{x:10,y:10},{x:9,y:10},{x:8,y:10}];
  dir         = {x:1,y:0};
  nextDir     = {x:1,y:0};
  score       = 0;
  level       = 0;
  paused      = false;
  gameRunning = true;

  updateSpeedDots();
  document.getElementById('score').textContent = 0;
  placeFood();
  clearInterval(gameLoop);
  gameLoop = setInterval(tick, getSpeed());
  blurActive();
}

function tick() {
  if (paused) return;
  dir = {...nextDir};
  const head = {x: snake[0].x+dir.x, y: snake[0].y+dir.y};
  if (head.x<0||head.x>=COLS||head.y<0||head.y>=ROWS) return endGame();
  if (snake.some(s=>s.x===head.x&&s.y===head.y))      return endGame();

  snake.unshift(head);

  if (head.x===food.x && head.y===food.y) {
    score += 10*(level+1);
    document.getElementById('score').textContent = score;
    const nl = Math.min(Math.floor(score/80), 4);
    if (nl > level) {
      level = nl;
      clearInterval(gameLoop);
      gameLoop = setInterval(tick, getSpeed());
      updateSpeedDots();
    }
    placeFood();
  } else {
    snake.pop();
  }
  draw();
}

function endGame() {
  clearInterval(gameLoop);
  gameRunning = false;

  const isNewBest = score > best;
  if (isNewBest) {
    best = score;
    try { localStorage.setItem('serpentine_best', best); } catch(_) {}
    document.getElementById('best').textContent = best;
  }

  document.getElementById('gameOverMsg').textContent = isNewBest ? 'ğŸ† NEW BEST!' : 'YOUR SCORE';
  document.getElementById('finalScore').textContent  = score;

  // Pre-fill name/email from last session
  try {
    const saved = JSON.parse(localStorage.getItem('serpentine_player') || '{}');
    if (saved.name)  document.getElementById('inputName').value  = saved.name;
    if (saved.email) document.getElementById('inputEmail').value = saved.email;
  } catch(_) {}

  document.getElementById('gameOverOverlay').classList.remove('hidden');

  // Death flash
  let f=0;
  const fi=setInterval(()=>{
    ctx.fillStyle = f%2===0?'rgba(255,34,102,0.28)':'transparent';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    if(++f>=6) clearInterval(fi);
  },80);
}

// â”€â”€ Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function draw() {
  ctx.fillStyle='#0f0f1a';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.fillStyle='rgba(0,255,136,0.05)';
  for(let x=0;x<COLS;x++) for(let y=0;y<ROWS;y++)
    ctx.fillRect(x*CELL+CELL/2-1, y*CELL+CELL/2-1, 2, 2);

  // Food
  ctx.save();
  ctx.shadowColor='#ff2266'; ctx.shadowBlur=15; ctx.fillStyle='#ff2266';
  ctx.beginPath(); ctx.arc(food.x*CELL+CELL/2,food.y*CELL+CELL/2,CELL/2-2,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#ff88aa';
  ctx.beginPath(); ctx.arc(food.x*CELL+CELL/2-2,food.y*CELL+CELL/2-2,3,0,Math.PI*2); ctx.fill();
  ctx.restore();

  // Snake
  snake.forEach((seg,i) => {
    const isHead=i===0, t=i/snake.length;
    ctx.save();
    if(isHead){ ctx.shadowColor='#00ff88';ctx.shadowBlur=18;ctx.fillStyle='#00ff88'; }
    else { ctx.shadowColor='rgba(0,255,136,0.3)';ctx.shadowBlur=6;ctx.fillStyle=`hsl(150,100%,${Math.floor(60+(1-t)*60)}%)`; }
    const pad=isHead?1:2;
    roundRect(ctx,seg.x*CELL+pad,seg.y*CELL+pad,CELL-pad*2,CELL-pad*2,isHead?5:3);
    ctx.fill();
    if(isHead){
      ctx.shadowBlur=0;ctx.fillStyle='#001a0a';
      if(dir.x!==0){ ctx.fillRect(seg.x*CELL+CELL/2+dir.x*3,seg.y*CELL+4,3,3); ctx.fillRect(seg.x*CELL+CELL/2+dir.x*3,seg.y*CELL+CELL-7,3,3); }
      else          { ctx.fillRect(seg.x*CELL+4,seg.y*CELL+CELL/2+dir.y*3,3,3); ctx.fillRect(seg.x*CELL+CELL-7,seg.y*CELL+CELL/2+dir.y*3,3,3); }
    }
    ctx.restore();
  });
}

// Initial idle draw
snake=[{x:10,y:10},{x:9,y:10},{x:8,y:10}]; dir={x:1,y:0}; food={x:14,y:7}; draw();

// â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const KEY_MAP = {
  ArrowUp:{x:0,y:-1},ArrowDown:{x:0,y:1},ArrowLeft:{x:-1,y:0},ArrowRight:{x:1,y:0},
  w:{x:0,y:-1},s:{x:0,y:1},a:{x:-1,y:0},d:{x:1,y:0},
};
const GAME_KEYS = new Set(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','w','a','s','d','W','A','S','D','p','P']);

function applyDir(nd) {
  if(!gameRunning) return;
  if(nd.x !== -dir.x || nd.y !== -dir.y) nextDir=nd;
}

function handleKey(e) {
  // Let the user type in input fields
  if(e.target.tagName==='INPUT') return;
  const k=e.key;
  if(!GAME_KEYS.has(k)) return;
  e.preventDefault();
  if(k==='p'||k==='P'){ if(gameRunning) paused=!paused; return; }
  const nd=KEY_MAP[k]||KEY_MAP[k.toLowerCase()];
  if(nd) applyDir(nd);
}
window.addEventListener('keydown',   handleKey, {capture:true});
document.addEventListener('keydown', handleKey, {capture:true});

// Buttons
document.getElementById('startBtn').addEventListener('click',   () => { startGame(); blurActive(); });
document.getElementById('restartBtn').addEventListener('click', () => { startGame(); blurActive(); });
document.getElementById('showLbBtn').addEventListener('click',  () => { loadLeaderboard(); blurActive(); });
document.getElementById('lbRefresh').addEventListener('click',  () => { loadLeaderboard(true); });

[['btn-up',{x:0,y:-1}],['btn-down',{x:0,y:1}],['btn-left',{x:-1,y:0}],['btn-right',{x:1,y:0}]]
  .forEach(([id,nd]) => document.getElementById(id).addEventListener('click',()=>{applyDir(nd);blurActive();}));

// Touch swipe
let touchStart=null;
canvas.addEventListener('touchstart',e=>{touchStart=e.touches[0];e.preventDefault();},{passive:false});
canvas.addEventListener('touchend',e=>{
  if(!touchStart)return;
  const dx=e.changedTouches[0].clientX-touchStart.clientX;
  const dy=e.changedTouches[0].clientY-touchStart.clientY;
  if(Math.abs(dx)>Math.abs(dy)) applyDir(dx>0?{x:1,y:0}:{x:-1,y:0});
  else                          applyDir(dy>0?{x:0,y:1}:{x:0,y:-1});
  e.preventDefault();
},{passive:false});

// â”€â”€ Leaderboard API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadLeaderboard(spin=false) {
  const body    = document.getElementById('lbBody');
  const btn     = document.getElementById('lbRefresh');
  body.innerHTML = '<div class="lb-loading">LOADING...</div>';
  if(spin){ btn.classList.add('spinning'); setTimeout(()=>btn.classList.remove('spinning'),600); }

  try {
    const res  = await fetch('/api/leaderboard');
    const rows = await res.json();
    renderLeaderboard(rows);
  } catch(_) {
    body.innerHTML = '<div class="lb-empty">FAILED TO LOAD<br>CHECK CONNECTION</div>';
  }
}

function renderLeaderboard(rows) {
  const body = document.getElementById('lbBody');
  if(!rows.length){
    body.innerHTML='<div class="lb-empty">NO SCORES YET<br>BE THE FIRST!</div>';
    return;
  }
  const rankLabel = (i) => {
    if(i===0) return '<span class="lb-rank gold">ğŸ¥‡</span>';
    if(i===1) return '<span class="lb-rank silver">ğŸ¥ˆ</span>';
    if(i===2) return '<span class="lb-rank bronze">ğŸ¥‰</span>';
    return `<span class="lb-rank">#${i+1}</span>`;
  };
  body.innerHTML = rows.map((r,i) => `
    <div class="lb-row${r.email===currentPlayerEmail?' me':''}">
      ${rankLabel(i)}
      <div class="lb-info">
        <div class="lb-name">${esc(r.name)}</div>
        <div class="lb-email">${esc(r.email)}</div>
      </div>
      <div class="lb-score">${r.score}</div>
    </div>
  `).join('');
}

function esc(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€ Submit score â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('submitBtn').addEventListener('click', async () => {
  const name  = document.getElementById('inputName').value.trim();
  const email = document.getElementById('inputEmail').value.trim();
  const msg   = document.getElementById('submitMsg');

  if(!name)  { msg.className='submit-msg err'; msg.textContent='âš  ENTER YOUR NAME'; return; }
  if(!email || !email.includes('@')) { msg.className='submit-msg err'; msg.textContent='âš  ENTER VALID EMAIL'; return; }

  msg.className='submit-msg'; msg.textContent='SUBMITTING...';
  document.getElementById('submitBtn').disabled=true;

  try {
    const res  = await fetch('/api/leaderboard',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({name, email, score})
    });
    const data = await res.json();
    if(data.ok){
      currentPlayerEmail=email;
      // Save for next time
      try { localStorage.setItem('serpentine_player', JSON.stringify({name,email})); } catch(_) {}

      msg.className='submit-msg ok';
      msg.textContent = data.rank ? `âœ… RANK #${data.rank} ON BOARD!` : 'âœ… SCORE SAVED!';
      document.getElementById('submitForm').style.display='none';
      document.getElementById('goRank').textContent = data.rank ? `ğŸ† YOU ARE RANK #${data.rank}` : '';
      loadLeaderboard(); // refresh leaderboard
    } else {
      msg.className='submit-msg err'; msg.textContent='âš  '+data.error;
      document.getElementById('submitBtn').disabled=false;
    }
  } catch(_) {
    msg.className='submit-msg err'; msg.textContent='âš  NETWORK ERROR';
    document.getElementById('submitBtn').disabled=false;
  }
});

// â”€â”€ Initial leaderboard load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadLeaderboard();
</script>
</body>
</html>